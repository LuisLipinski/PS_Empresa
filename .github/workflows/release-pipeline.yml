name: Release Pipeline

on:
  push:
    branches: [ master ]

# üîí Impede dois deploys ao mesmo tempo (resolve o "Deploy canceled" do Render)
concurrency:
  group: render-production
  cancel-in-progress: true

permissions:
  contents: write

jobs:

  # ---------------- BUILD ----------------
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: maven

      - name: Build application
        run: mvn -B clean package -DskipTests

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-build
          path: target/*.jar

  # ---------------- DEPLOY RENDER ----------------
  deploy-render:
    # garante que s√≥ roda quando realmente √© merge na master
    if: github.ref == 'refs/heads/master'
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Trigger Render Deploy
        env:
          RENDER_DEPLOY_HOOK: ${{ secrets.RENDER_DEPLOY_HOOK }}
        run: |
          echo "Disparando deploy no Render..."
          curl -fsSL -X POST "$RENDER_DEPLOY_HOOK"
          echo "Webhook enviado com sucesso"

  # ---------------- WAIT HEALTH ----------------
  wait-new-version:
    needs: deploy-render
    runs-on: ubuntu-latest

    steps:

      - name: Wait actuator online
        run: |
          echo "Aguardando actuator ficar dispon√≠vel..."

          for i in {1..60}; do
            RESPONSE=$(curl -s https://ps-empresa.onrender.com/actuator/health || true)

            if echo "$RESPONSE" | grep '"status"'; then
              echo "Actuator dispon√≠vel!"
              break
            fi

            echo "Actuator ainda n√£o respondeu... aguardando 10s"
            sleep 10
          done

#      - name: Capture current start time
#        id: before
#        run: |
#          echo "Capturando start atual..."
#
#          START=$(curl -s https://ps-empresa.onrender.com/actuator/metrics/process.start.time \
#            | jq -r '.measurements[0].value')
#
#          echo "old=$START" >> $GITHUB_OUTPUT
#          echo "Start atual: $START"
#
#      - name: Wait new container
#        run: |
#          OLD=${{ steps.before.outputs.old }}
#
#          echo "Esperando novo container entrar..."
#
#          for i in {1..80}; do
#            NEW=$(curl -s https://ps-empresa.onrender.com/actuator/metrics/process.start.time \
#              | jq -r '.measurements[0].value' || echo "fail")
#
#            if [ "$NEW" = "fail" ]; then
#              echo "Container ainda reiniciando..."
#              sleep 15
#              continue
#            fi
#
#            echo "Start atual em produ√ß√£o: $NEW"
#
#            if [ "$NEW" != "$OLD" ]; then
#              echo "Novo deploy confirmado!"
#              exit 0
#            fi
#
#            echo "Ainda √© a vers√£o antiga... aguardando 15s"
#            sleep 15
#          done
#
#          echo "Novo deploy n√£o foi detectado"
#          exit 1

  # ---------------- SMOKE TEST ----------------
  smoke:
    needs: wait-new-version
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          repository: LuisLipinski/ps_automacao_backend
          path: qa-tests
          token: ${{ secrets.GH_TOKEN }}

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        working-directory: qa-tests
        run: npm ci

      - name: Install Playwright
        working-directory: qa-tests
        run: npx playwright install --with-deps

      - name: Run Smoke Tests
        working-directory: qa-tests
        env:
          PS_EMPRESA_URL: https://ps-empresa.onrender.com
        run: npm run empresa:smoke:render

  # ---------------- CORE REGRESSION ----------------
  core-regression:
    needs: smoke
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          repository: LuisLipinski/ps_automacao_backend
          path: qa-tests
          token: ${{ secrets.GH_TOKEN }}

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        working-directory: qa-tests
        run: npm ci

      - name: Install Playwright
        working-directory: qa-tests
        run: npx playwright install --with-deps

      - name: Run Core Regression
        working-directory: qa-tests
        env:
          PS_EMPRESA_URL: https://ps-empresa.onrender.com
        run: npm run empresa:regression:render

  # ---------------- RELEASE TAG ----------------
  release-production:
    needs: core-regression
    runs-on: ubuntu-latest
    environment: production

    steps:
      - uses: actions/checkout@v4

      - name: Create Release Tag
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          VERSION=v1.${{ github.run_number }}
          git tag $VERSION
          git push origin $VERSION